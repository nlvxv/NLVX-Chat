<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLVX Chat</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        /* CSS is 100% final and correct. No changes needed. */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap' );
        :root{--primary-color:#007bff;--background-color:#0d1117;--surface-color-1:#161b22;--surface-color-2:#010409;--text-color:#c9d1d9;--text-muted:#8b949e;--border-color:#30363d;--sent-bg:linear-gradient(135deg, #007bff, #0056b3);--received-bg:#21262d;--hover-bg:rgba(255, 255, 255, 0.05);--popover-bg:#2a2f38;}
        *{box-sizing:border-box;}
        body{font-family:'Poppins',sans-serif;background-color:var(--background-color);color:var(--text-color);margin:0;height:100vh;overflow:hidden;}
        .main-layout{display:grid;grid-template-columns:240px 1fr;height:100vh;}
        .conversations-sidebar{background-color:var(--surface-color-2);display:flex;flex-direction:column;border-right:1px solid var(--border-color);}
        .sidebar-header{padding:20px;font-size:1.2em;font-weight:600;border-bottom:1px solid var(--border-color);color:#fff;}
        .conversations-list{flex-grow:1;overflow-y:auto;padding:10px 0;}
        .conversation-item{display:flex;align-items:center;padding:12px 20px;cursor:pointer;transition:background-color 0.2s ease;user-select:none;}
        .conversation-item.active,.conversation-item:hover{background-color:var(--hover-bg);}
        .avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.2em;margin-right:12px;flex-shrink:0;}
        .conversation-name{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .chat-view{display:grid;grid-template-columns:1fr 240px;height:100vh;}
        .chat-container{display:flex;flex-direction:column;height:100%;background-color:var(--surface-color-1);}
        .chat-header{padding:20px 25px;border-bottom:1px solid var(--border-color);font-size:1.2em;font-weight:600;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:10;}
        .messages-area{flex-grow:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column-reverse;}
        .messages-list{display:flex;flex-direction:column;gap:15px;}
        .message{padding:12px 18px;border-radius:20px;max-width:75%;display:flex;flex-direction:column;opacity:0;transform:scale(0.95);animation:messagePopIn 0.3s forwards cubic-bezier(0.4, 1.5, 0.75, 1.25);}
        @keyframes messagePopIn{to{opacity:1;transform:scale(1);}}
        .message .username{font-weight:600;font-size:0.9em;margin-bottom:5px;color:var(--primary-color);}
        .message.sent{background:var(--sent-bg);color:white;align-self:flex-end;border-bottom-right-radius:5px;}
        .message.sent .username{color:rgba(255, 255, 255, 0.8);}
        .message.received{background:var(--received-bg);color:var(--text-color);align-self:flex-start;border-bottom-left-radius:5px;}
        .input-area{display:flex;padding:15px 20px;border-top:1px solid var(--border-color);gap:10px;}
        #message-input{flex-grow:1;padding:14px 20px;border:1px solid var(--border-color);background-color:var(--background-color);color:var(--text-color);border-radius:24px;font-size:1em;transition:all 0.3s ease;}
        #message-input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0, 123, 255, 0.25);}
        #send-button{display:flex;align-items:center;justify-content:center;width:50px;height:50px;border:none;background-color:var(--primary-color);color:white;border-radius:50%;cursor:pointer;transition:all 0.3s ease;flex-shrink:0;}
        #send-button:hover{background-color:#0056b3;transform:rotate(15deg) scale(1.1);}
        #send-button svg{width:24px;height:24px;}
        .users-sidebar{background-color:var(--surface-color-2);border-left:1px solid var(--border-color);display:flex;flex-direction:column;}
        .users-list{flex-grow:1;overflow-y:auto;padding:10px 0;}
        .user-item{display:flex;align-items:center;padding:10px 20px;cursor:pointer;transition:background-color 0.2s ease;position:relative;}
        .user-item:hover{background-color:var(--hover-bg);}
        .user-name{font-weight:500;}
        .profile-popover{position:fixed;width:250px;background-color:var(--popover-bg);border-radius:12px;border:1px solid var(--border-color);box-shadow:0 8px 24px rgba(0,0,0,0.4);padding:20px;z-index:100;display:none;flex-direction:column;align-items:center;gap:15px;transform:scale(0.95);opacity:0;transition:transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s ease;}
        .profile-popover.visible{display:flex;transform:scale(1);opacity:1;}
        .popover-avatar{width:80px;height:80px;font-size:3em;}
        .popover-username{font-size:1.4em;font-weight:600;color:#fff;}
        .popover-button{width:100%;padding:12px;border:none;background-color:var(--primary-color);color:white;font-size:1em;font-weight:500;border-radius:8px;cursor:pointer;transition:background-color 0.2s ease;}
        .popover-button:hover{background-color:#0056b3;}
        ::-webkit-scrollbar{width:8px;}
        ::-webkit-scrollbar-track{background:transparent;}
        ::-webkit-scrollbar-thumb{background-color:#444;border-radius:10px;}
        ::-webkit-scrollbar-thumb:hover{background-color:#555;}
    </style>
</head>
<body>

    <!-- THE HTML STRUCTURE IS NOW CORRECTLY INCLUDED -->
    <div class="main-layout">
        <aside class="conversations-sidebar">
            <div class="sidebar-header">NLVX Chat</div>
            <div class="conversations-list" id="conversations-list">
                <div class="conversation-item active" data-channel-id="public-room">
                    <div class="avatar">P</div>
                    <div class="conversation-name">Public Room</div>
                </div>
            </div>
        </aside>

        <main class="chat-view">
            <div class="chat-container">
                <header class="chat-header" id="chat-header">Public Room</header>
                <main class="messages-area">
                    <div class="messages-list" id="messages-list"></div>
                </main>
                <footer class="input-area">
                    <input type="text" id="message-input" placeholder="Message in Public Room...">
                    <button id="send-button" title="Send">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                    </button>
                </footer>
            </div>

            <aside class="users-sidebar">
                <div class="sidebar-header">ONLINE</div>
                <div class="users-list" id="users-list"></div>
            </aside>
        </main>
    </div>

    <div id="profile-popover" class="profile-popover">
        <div id="popover-avatar" class="avatar popover-avatar"></div>
        <div id="popover-username" class="popover-username"></div>
        <button id="popover-message-btn" class="popover-button">Message</button>
    </div>

    <script>
    // THE JAVASCRIPT LOGIC IS THE SAME AS THE PREVIOUS CORRECT VERSION
    const currentUser = {
        name: localStorage.getItem('nlvx_username' ),
        id: localStorage.getItem('nlvx_username')
    };

    if (!currentUser.id) {
        window.location.href = 'index.html';
    }

    let activeChannel;

    const messagesList = document.getElementById('messages-list');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const usersListUI = document.getElementById('users-list');
    const popover = document.getElementById('profile-popover');
    const popoverAvatar = document.getElementById('popover-avatar');
    const popoverUsername = document.getElementById('popover-username');
    const popoverMessageBtn = document.getElementById('popover-message-btn');

    const ably = new Ably.Realtime({
        key: 'AOSWlQ.RNZ3Sw:ilbVxgdgZXFnBUFUU6vP4iC6qp5f3-qIVhMEGR1gzN4',
        clientId: currentUser.id
    });

    async function setupChannel(channelId) {
        activeChannel = ably.channels.get(channelId);

        await activeChannel.subscribe((message) => {
            if (message.clientId !== currentUser.id) {
                addMessageUI(message.data.text, message.data.senderName);
            }
        });

        const presence = activeChannel.presence;
        await presence.subscribe(['enter', 'present', 'leave'], updateUserList);
        await presence.enter({ name: currentUser.name });
        
        updateUserList();
    }

    async function updateUserList() {
        if (!activeChannel) return;
        const members = await activeChannel.presence.get();
        usersListUI.innerHTML = '';
        members.forEach(member => {
            if (member.data && member.data.name) {
                addUserUI(member.data.name, member.clientId);
            }
        });
    }

    function sendMessage() {
        const messageText = messageInput.value.trim();
        if (messageText && activeChannel) {
            activeChannel.publish({ data: { text: messageText, senderName: currentUser.name } });
            addMessageUI(messageText, currentUser.name, true);
            messageInput.value = '';
            messageInput.focus();
        }
    }

    function addMessageUI(text, senderName, isSentByCurrentUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', isSentByCurrentUser ? 'sent' : 'received');
        messageDiv.innerHTML = `<span class="username">${senderName}</span><span>${text}</span>`;
        messagesList.append(messageDiv);
        messagesList.parentElement.scrollTop = messagesList.parentElement.scrollHeight;
    }

    function addUserUI(name, id) {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        const firstLetter = name ? name.charAt(0).toUpperCase() : '?';
        userItem.innerHTML = `<div class="avatar">${firstLetter}</div><div class="user-name">${name}</div>`;
        if (id !== currentUser.id) {
            userItem.addEventListener('click', (event) => {
                showPopover({ id, name }, event.currentTarget);
            });
        }
        usersListUI.appendChild(userItem);
    }

    function showPopover(user, targetElement) {
        popoverAvatar.textContent = user.name.charAt(0).toUpperCase();
        popoverUsername.textContent = user.name;
        popoverMessageBtn.dataset.targetUser = JSON.stringify(user);
        const rect = targetElement.getBoundingClientRect();
        popover.style.top = `${rect.top}px`;
        popover.style.left = `${rect.right + 10}px`;
        popover.classList.add('visible');
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendMessage();
        }
    });
    document.addEventListener('click', (event) => {
        if (!popover.contains(event.target) && !event.target.closest('.user-item')) {
            popover.classList.remove('visible');
        }
    });
    popoverMessageBtn.addEventListener('click', () => {
        const user = JSON.parse(popoverMessageBtn.dataset.targetUser);
        alert(`Starting private chat with ${user.name}... (Functionality coming next!)`);
        popover.classList.remove('visible');
    });

    ably.connection.on('connected', () => {
        setupChannel('nlvx-chat-public-room-v4'); // Using a new channel name to ensure a fresh start
    });
    ably.connection.on('failed', (error) => {
        console.error('Ably connection failed:', error);
        alert('Error: Could not connect to chat service.');
    });
    </script>
</body>
</html>
