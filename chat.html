<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLVX Chat</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap' );
        :root{--primary-color:#007bff;--background-color:#0d1117;--surface-color-1:#161b22;--surface-color-2:#010409;--text-color:#c9d1d9;--text-muted:#8b949e;--border-color:#30363d;--sent-bg:linear-gradient(135deg, #007bff, #0056b3);--received-bg:#21262d;--hover-bg:rgba(255, 255, 255, 0.05);--popover-bg:#2a2f38;--danger-color:#dc3545;}
        *{box-sizing:border-box;}
        body{font-family:'Poppins',sans-serif;background-color:var(--background-color);color:var(--text-color);margin:0;height:100vh;overflow:hidden;}
        .main-layout{display:grid;grid-template-columns:240px 1fr;height:100vh;}
        .conversations-sidebar{background-color:var(--surface-color-2);display:flex;flex-direction:column;border-right:1px solid var(--border-color);}
        .sidebar-header{display:flex;align-items:center;justify-content:space-between;padding:15px 20px;height:65px;font-size:1.2em;font-weight:600;border-bottom:1px solid var(--border-color);color:#fff;}
        .sidebar-title{margin:0;}
        #back-to-chat-btn{display:none;background:none;border:none;color:var(--text-muted);cursor:pointer;padding:5px;}
        #back-to-chat-btn svg{width:24px;height:24px;fill:currentColor;}
        .conversations-list{flex-grow:1;overflow-y:auto;padding:10px 0;}
        .conversation-item{display:flex;align-items:center;padding:12px 20px;cursor:pointer;transition:background-color 0.2s ease;user-select:none;}
        .conversation-item.active,.conversation-item:hover{background-color:var(--hover-bg);}
        .avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.2em;margin-right:12px;flex-shrink:0;}
        .conversation-name{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .chat-view{display:grid;grid-template-columns:1fr 240px;height:100vh;}
        .chat-container{display:flex;flex-direction:column;height:100%;background-color:var(--surface-color-1);}
        .chat-header{display:flex;justify-content:space-between;align-items:center;padding:15px 25px;height:65px;border-bottom:1px solid var(--border-color);font-size:1.2em;font-weight:600;color:#fff;z-index:10;}
        .mobile-nav{display:none;gap:15px;}
        .mobile-nav-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:5px;}
        .mobile-nav-btn.active{color:var(--primary-color);}
        .mobile-nav-btn svg{width:24px;height:24px;fill:currentColor;}
        .messages-area{flex-grow:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column-reverse;}
        .messages-list{display:flex;flex-direction:column;gap:15px;margin-top:auto;}
        .message{position:relative;padding:12px 18px;border-radius:20px;max-width:80%;display:flex;flex-direction:column;opacity:0;transform:scale(0.95);animation:messagePopIn 0.3s forwards cubic-bezier(0.4, 1.5, 0.75, 1.25);}
        @keyframes messagePopIn{to{opacity:1;transform:scale(1);}}
        .message .username{font-weight:600;font-size:0.9em;margin-bottom:5px;color:var(--primary-color);cursor:pointer;transition: color 0.2s ease;}
        .message .username:hover{color:#3caeff;}
        .message.sent{background:var(--sent-bg);color:white;align-self:flex-end;border-bottom-right-radius:5px;}
        .message.sent .username{color:rgba(255, 255, 255, 0.8);}
        .message.received{background:var(--received-bg);color:var(--text-color);align-self:flex-start;border-bottom-left-radius:5px;}
        .input-area{display:flex;padding:15px 20px;border-top:1px solid var(--border-color);gap:10px;}
        #message-input{flex-grow:1;padding:14px 20px;border:1px solid var(--border-color);background-color:var(--background-color);color:var(--text-color);border-radius:24px;font-size:1em;transition:all 0.3s ease;}
        #message-input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0, 123, 255, 0.25);}
        #send-button{display:flex;align-items:center;justify-content:center;width:50px;height:50px;border:none;background-color:var(--primary-color);color:white;border-radius:50%;cursor:pointer;transition:all 0.3s ease;flex-shrink:0;}
        #send-button:hover{background-color:#0056b3;transform:rotate(15deg) scale(1.1);}
        #send-button svg{width:24px;height:24px;}
        .users-sidebar{background-color:var(--surface-color-2);border-left:1px solid var(--border-color);display:flex;flex-direction:column;}
        .users-list{flex-grow:1;overflow-y:auto;padding:10px 0;}
        .user-item{display:flex;align-items:center;padding:10px 20px;cursor:pointer;transition:background-color 0.2s ease;position:relative;}
        .user-item:hover{background-color:var(--hover-bg);}
        .user-name{font-weight:500;}
        .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);z-index:1000;display:flex;justify-content:center;align-items:center;opacity:0;pointer-events:none;transition:opacity 0.3s ease;}
        .modal-backdrop.visible{opacity:1;pointer-events:auto;}
        .profile-modal{background-color:var(--surface-color-1);width:90%;max-width:400px;border-radius:12px;border:1px solid var(--border-color);box-shadow:0 10px 40px rgba(0,0,0,0.4);transform:scale(0.9);transition:transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);}
        .modal-backdrop.visible .profile-modal{transform:scale(1);}
        .modal-header{padding:20px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:20px;}
        .modal-avatar{width:80px;height:80px;font-size:3em;border-radius:50%;}
        .modal-username{font-size:1.8em;font-weight:600;color:#fff;}
        .modal-body{padding:20px;}
        .info-group{margin-bottom:15px;}
        .info-group label{display:block;font-size:0.9em;color:var(--text-muted);margin-bottom:5px;}
        .info-group p{font-size:1.1em;color:var(--text-color);}
        .modal-footer{padding:20px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;}
        .modal-button{padding:10px 20px;border:none;background-color:var(--primary-color);color:white;font-size:1em;font-weight:500;border-radius:8px;cursor:pointer;transition:background-color 0.2s ease;}
        .modal-button:hover{background-color:#0056b3;}
        ::-webkit-scrollbar{width:8px;}
        ::-webkit-scrollbar-track{background:transparent;}
        ::-webkit-scrollbar-thumb{background-color:#444;border-radius:10px;}
        ::-webkit-scrollbar-thumb:hover{background-color:#555;}
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .conversations-sidebar { display: none; }
            .chat-view { grid-template-columns: 1fr; position: relative; overflow: hidden; }
            .mobile-nav { display: flex; }
            .users-sidebar { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 20; border-left: none; }
            .users-sidebar.visible { transform: translateX(0); }
            .chat-container { width: 100%; height: 100%; }
            .message .username { pointer-events: none; }
            #back-to-chat-btn { display: block; }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <aside class="conversations-sidebar">
            <div class="sidebar-header"><h1 class="sidebar-title">NLVX Chat</h1></div>
            <div class="conversations-list" id="conversations-list">
                <div class="conversation-item active" data-channel-id="public-room">
                    <div class="avatar">P</div><div class="conversation-name">Public Room</div>
                </div>
            </div>
        </aside>
        <main class="chat-view">
            <div class="chat-container" id="chat-container">
                <header class="chat-header">
                    <h1 class="sidebar-title">Public Room</h1>
                    <div class="mobile-nav">
                        <button class="mobile-nav-btn" id="show-users-btn" title="Users"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></svg></button>
                    </div>
                </header>
                <main class="messages-area" id="messages-area"><div class="messages-list" id="messages-list"></div></main>
                <footer class="input-area">
                    <input type="text" id="message-input" placeholder="Message in Public Room..."><button id="send-button" title="Send"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button>
                </footer>
            </div>
            <aside class="users-sidebar" id="users-sidebar">
                <header class="sidebar-header">
                    <button id="back-to-chat-btn" title="Back to chat"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button>
                    <h1 class="sidebar-title">Online</h1>
                </header><div class="users-list" id="users-list"></div>
            </aside>
        </main>
    </div>
    <div class="modal-backdrop" id="profile-modal-backdrop">
        <div class="profile-modal" id="profile-modal">
            <header class="modal-header">
                <div class="avatar modal-avatar" id="modal-avatar"></div><h2 class="modal-username" id="modal-username"></h2>
            </header>
            <div class="modal-body">
                <div class="info-group"><label>User ID</label><p id="modal-userid"></p></div>
                <div class="info-group"><label>Status</label><p>Online</p></div>
            </div>
            <footer class="modal-footer"><button class="modal-button" id="modal-message-btn">Message</button></footer>
        </div>
    </div>

    <script>
    const currentUser = { name: localStorage.getItem('nlvx_username'), id: localStorage.getItem('nlvx_username') };
    if (!currentUser.id) { window.location.href = 'index.html'; }

    const elements = {
        messagesArea: document.getElementById('messages-area'),
        messagesList: document.getElementById('messages-list'),
        messageInput: document.getElementById('message-input'),
        sendButton: document.getElementById('send-button'),
        usersListUI: document.getElementById('users-list'),
        usersSidebar: document.getElementById('users-sidebar'),
        showUsersBtn: document.getElementById('show-users-btn'),
        backToChatBtn: document.getElementById('back-to-chat-btn'),
        profileModalBackdrop: document.getElementById('profile-modal-backdrop'),
        modalAvatar: document.getElementById('modal-avatar'),
        modalUsername: document.getElementById('modal-username'),
        modalUserid: document.getElementById('modal-userid'),
        modalMessageBtn: document.getElementById('modal-message-btn')
    };

    let activeChannel;
    let membersMap = new Map();
    const ably = new Ably.Realtime({ key: 'AOSWlQ.RNZ3Sw:ilbVxgdgZXFnBUFUU6vP4iC6qp5f3-qIVhMEGR1gzN4', clientId: currentUser.id });

    async function setupChannel(channelId) {
        activeChannel = ably.channels.get(`chat:${channelId}`);
        
        await activeChannel.subscribe('message', (message) => {
            addMessageUI(message.data, message.id);
        });

        const presence = activeChannel.presence;
        
        presence.subscribe(['enter', 'leave', 'update'], async () => {
            const presenceMembers = await presence.get();
            membersMap.clear();
            presenceMembers.forEach(member => {
                membersMap.set(member.clientId, member.data);
            });
            renderUserList();
        });
        
        await presence.enter({ name: currentUser.name });
    }

    function renderUserList() {
        elements.usersListUI.innerHTML = '';
        membersMap.forEach((data, id) => {
            if (data && data.name) {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `<div class="avatar">${data.name.charAt(0).toUpperCase()}</div><div class="user-name">${data.name}</div>`;
                if (id !== currentUser.id) {
                    userItem.onclick = () => showProfileModal({ id, name: data.name });
                }
                elements.usersListUI.appendChild(userItem);
            }
        });
    }

    function sendMessage() {
        const text = elements.messageInput.value.trim();
        if (text && activeChannel) {
            activeChannel.publish('message', { text, sender: currentUser });
            elements.messageInput.value = '';
            elements.messageInput.focus();
        }
    }

    function addMessageUI(data, messageId) {
        const isSent = data.sender.id === currentUser.id;
        const messageDiv = document.createElement('div');
        messageDiv.id = messageId;
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        
        const usernameHTML = `<span class="username" data-user-id="${data.sender.id}">${data.sender.name}</span>`;
        messageDiv.innerHTML = `${usernameHTML}<span>${data.text}</span>`;
        
        elements.messagesList.append(messageDiv);
        elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
    }

    function showProfileModal(user) {
        elements.modalAvatar.textContent = user.name.charAt(0).toUpperCase();
        elements.modalUsername.textContent = user.name;
        elements.modalUserid.textContent = user.id;
        elements.profileModalBackdrop.classList.add('visible');
    }

    function hideProfileModal() {
        elements.profileModalBackdrop.classList.remove('visible');
    }

    // --- EVENT LISTENERS ---
    elements.sendButton.onclick = sendMessage;
    elements.messageInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    elements.showUsersBtn.onclick = () => elements.usersSidebar.classList.add('visible');
    elements.backToChatBtn.onclick = () => elements.usersSidebar.classList.remove('visible');
    elements.profileModalBackdrop.onclick = (e) => { if (e.target === elements.profileModalBackdrop) hideProfileModal(); };
    elements.modalMessageBtn.onclick = () => {
        alert(`Starting private chat with ${elements.modalUsername.textContent}...`);
        hideProfileModal();
    };

    // Event Delegation for clicking usernames in chat
    elements.messagesList.onclick = (e) => {
        const target = e.target;
        if (target.classList.contains('username')) {
            const userId = target.dataset.userId;
            if (userId !== currentUser.id && membersMap.has(userId)) {
                showProfileModal({ id: userId, name: membersMap.get(userId).name });
            }
        }
    };

    ably.connection.on('connected', () => setupChannel('public-room-stable'));
    ably.connection.on('failed', (err) => console.error('Ably connection failed:', err));
    </script>
</body>
</html>
